#!/usr/bin/env perl

package App::GherkinGeneratePickles;

use strict;
use warnings;
use lib 'lib';

use Cpanel::JSON::XS;
use Path::Class;

use Gherkin::Parser;
use Gherkin::Pickles::Compiler;

sub run {
    my ( $class, $fh, @file_list ) = @_;
    my $json = Cpanel::JSON::XS->new->utf8->canonical;

    my $parser = Gherkin::Parser->new();

    for my $file (@file_list) {
        my $source = file($file)->slurp;
        my $pickles = Gherkin::Pickles::Compiler->compile(
            $parser->parse($file), $source
        );
        for my $pickle (@$pickles) {
            print $fh $json->encode($pickle);
            print "\n"
        }
    }
}

__PACKAGE__->run(\*STDOUT, @ARGV) unless caller;
